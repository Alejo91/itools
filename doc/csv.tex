\documentclass[a4paper]{book}
\usepackage[latin1]{inputenc}
\usepackage{color}
\usepackage{psboxit}
\usepackage{verbatim}
\usepackage{psfrag}
\usepackage{itools}
\usepackage{makeidx}

\makeindex
\begin{document}




\chapter{The CSV file handler}
\index{CSV}

In this chapter you will learn how to work with CSV files using the
{\tt itools.csv} handler. The explanation will be driven by an example.


\section{What we want to do}

Let's assume that you are the owner of a small ISP (Internet Service
Provider) company. You have about 250 clients and all information
about your clients is stored in a file named {\tt clients.csv}.

In this file you have the client's personal data as name, surname
and address and his business data: when the last payment was, how many
computers the client connects to the network and when the client was
registered. In the file there is also the client's discount rate. 
Its value depends on the number of computers, the registration date
and it is change after payment.

You need an small system to store/change/remove the clients information
and to generate some reports (for example to send the payment email 
remainders to the clients). We will build that system from scratch
with {\tt itools.csv}.

Take a closer look at the structure of the {\tt clients.csv} file.
The column names (defined in handler schema, more info about it later)
and its type. The types are defined in {\tt itools.datatypes} module.

\begin{quote}
\begin{tabular}{|l|l|l|}
    \hline
    Column name & Data type & Description \\
    \hline
    client\_id & Integer & client ID \\
    surname & Unicode & client's surname \\
    name & Unicode & client's name \\
    address & Unicode & client's address \\
    email & Unicode & clients's email address \\
    last\_pay\_date & Date & the date of the last pay \\
    num\_of\_computers & Integer & how many computers are connected \\
    register\_date & Date & the registration date \\
    discount & Integer & discount rate \\
    \hline
\end{tabular}
\end{quote}

The system should allow us to:
\begin{itemize}
    \item get the list of clients
    \item add a new clients
    \item remove clients 
    \item modify the information about clients
    \item get info about sending payment reminders 
\end{itemize}


\section{Building the system}

How to do this task with {\tt itools.csv}? To work with the
database we should create the csv file handler:
\begin{code}
    >>> import itools.csv
    >>> from itools.resources import get_resource
    >>> resource = get_resource('clients.csv')
    >>> clients = itools.csv.CSV(resource)
\end{code}

How can we view the client from the first file row?
\begin{code}
    >>> clients.get_row(0)
    [u'1', u'Piotr', u'Macuk', u'Starowiejska 25/2 81-465 Gdynia',
    u'piotr@macuk.pl', u'2004-11-30', u'2', u'2001-01-05', u'35']
\end{code}
    
We can add a new client to the {\tt clients.csv} database:
\begin{code}
    >>> clients.add_row([4, 'Hanna', 'Nowak', 'Dlugi Targ 32 80-112 Gdansk',
    'hanka@onet.pl', '2005-11-12', 1, '2005-11-12', 0])
\end{code}

To remove the client from the third row (indexes start with 0) lest's try:
\begin{code}
    >>> clients.del_row(2)
\end{code}
As you can realize to do the above tasks, we should know the row index 
which the client's data are stored in the {\tt clients.csv} file database. 
We have the {\em client\_id}, but the csv handler has no idea about that. 
We should inform the handler about the structure of the database. To do that 
we define the columns and the schema of our clients' data and load the file 
content again. The csv file schema is dictionary mapping from column name to
datatype. We can also define columns to index. Indexed columns can be used
to search data by the column values.
\begin{code}
    >>> from itools.datatypes import *
    >>> columns = ['client_id', 'surname', 'name', 'address', 'email',
    ... 'last_pay_date', 'num_of_computers', 'register_date',
    ... 'discount']
    >>> schema = {'client_id': Integer(index=True), 
    ... 'surname': Unicode(index=True), 'name': Unicode, 
    ... 'address': Unicode, 'email': Unicode(index=True),
    ... 'last_pay_date': Date(index=True), 'num_of_computers': Integer,
    ... 'register_date': Date, 'discount': Integer}
    >>> clients.columns = columns
    >>> clients.schema = schema
    >>> clients.load_state(resource)
\end{code}

And now when we get the first row from our database, the data will have the 
appropriate types (the above get\_row(0) function call returned data as unicode 
strings).
\begin{code}
    >>> clients.get_row(0)
    [1, u'Piotr', u'Macuk', u'Starowiejska 25/2 81-465 Gdynia',
    u'piotr@macuk.pl', datetime.date(2004, 11, 30), 2, 
    datetime.date(2001, 1, 5), 35] 
\end{code}

The index parameter (for example: {\tt 'client\_id': Integer(index=True)})
will  tell the handler to index that column. We want to index {\em client\_id},
{\em surname}, {\em email} and {\em last\_pay\_date}.

Now, when we have the indexed client\_id column we can get the client
by the ID. We should find the row index with the appropriate client\_id,
and get that row from {\tt clients.csv} file.
\begin{code}
    >>> indexes = clients.search([('client_id', 1)])
    >>> clients.get_row(indexes[0])
    [1, u'Piotr', u'Macuk', u'Starowiejska 25/2 81-465 Gdynia', 
    u'piotr@macuk.pl', datetime.date(2004, 11, 30), 2, 
    datetime.date(2001, 1, 5), 35]
\end{code}
The search method returns the list of rows which include client\_id = 1.
That column is our unique client ID number thus we have to get the first
element from that list ({\tt indexes[0]}).

How we can find clients to send the payment reminder? Let's try:
\begin{code}
    >>> indexes = clients.search([
    ... ('last_pay_date', Date.decode('2004-11-30'))])
    >>> clients.get_rows(indexes)
    [[1, u'Piotr', u'Macuk', u'Starowiejska 25/2 81-465 Gdynia', 
    u'piotr@macuk.pl', datetime.date(2004, 11, 30), 2, 
    datetime.date(2001, 1, 5), 35], [2, u'Adam', u'Nowak', 
    u'Grunwaldzka 117/3 80-334 Sopot', u'adam.nowak@yahoo.com', 
    datetime.date(2004, 11, 30), 1, datetime.date(2002, 8, 2), 25]]
\end{code}

To build mentioned system you should define the class which will use the
{\tt itools.csv} module and give you some simple API to your problem. After
that you should write some scripts that use defined class.

You can find the example system in the 
{\tt examples/csv\_handler/my\_clients.py} and 
{\tt examples/csv\_handler/my\_system.py} files. The first file is the class
definition with: get, add, delete, modify, reminders and save method. 
All methods use the client\_id column to indicate the client. The second one
is the example system script. It uses the MyClients class. 
The source code has a lot of comments and you shuold analyze it.

Of course the above example system is not complete. System should register
payments and change the last\_payment\_date value and probably modify 
the discount rate accordingly. It is simple enhancement and you could do it 
by yourself if you need the system for small ISP company.

The source code used in that chapter is placed in \\
{\tt examples/csv\_handler/example.py} file.


\section{CSV handler API}

\begin{api}
  {\tt get\_row(index)}\\
  - Return row indexed by index.

  {\tt get\_rows(indexes)}\\
  - Return rows indexed by indexes.

  {\tt get\_all\_rows()}\\
  - Return all csv file rows.

  {\tt add\_row(row)}\\
  - Append the new row.

  {\tt del\_row(index)}\\
  - Delete row indexed by index.

  {\tt del\_rows(indexes)}\\
  - Delete rows indexed by indexes.

  {\tt get\_columns\_by\_names(columns)}\\
  - Return only selected columns by its names (names in self.columns).

  {\tt get\_columns\_by\_indexes(columns)}\\
  - Return only selected columns by numerical indexes.

  {\tt search(query)}\\
  - Return list of row indexes returned by executing the query
    or None when one or more query items is None (query item
    is None when the query item column is not indexed).
    The query item can be: 
    \begin{itemize}
        \item the (column\_name, value) tuple 
        \item the operator:  'or' or 'and'
        \item the list of the previous advanced\_search result.
    \end{itemize}
    
    The query parameter is list of query items for example:
    \begin{code}
    - [('name', 'dde')]
    - [('name', 'dde'), 'and', ('country', 'Sweden')]
    - [('name', 'dde'), 'or', ('name', 'fse'), 
       'and', ('country', 'France')]
    - [result1, 'and', result2, 'or', result3]
    \end{code}
\end{api}




\end{document}
