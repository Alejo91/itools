*************************************************************************
itools 0.50.0
*************************************************************************

These upgrade notes may not be complete. Thanks to report any problem you
find.

New Dependencies
================

The minimum required version of Python has been raised to 2.5.2.

The new "itools.xapian" package requires the Xapian library (xapian-core)
and its Python wrapper (xapian-bindings), version 1.0.7 or later.  To
download from "http://www.xapian.org".


Imports
=======

The package "itools.catalog" has been replaced by the package "itools.xapian",
but the API is the same, so only the import sentences must be updated.

Other objects have been renamed accross different packages, the table below
summarizes this changes.

  Before (alphabetical order)    Now
  ----------------------------   ---------------------------
  catalog.*                      xapian.*
  datatypes.FileName             vfs.FileName
  datatypes.XML                  datatypes.XMLContent
  gettext.Message                gettext.POUnit
  ical.icalendar                 ical.iCalendar
  i18n.Message                   srx.Message
  i18n.Multilingual              (REMOVED)
  tmx.Message                    tmx.TMXUnit
  tmx.Note                       tmx.TMXNote
  tmx.TMX                        tmx.TMXFile
  web.Node                       web.Resource
  web.Root                       web.RootResource
  xliff.Note                     xliff.XLFNote
  xliff.Translation              xliff.XLFUnit
  xliff.XLIFF                    xliff.XLFFile
  xml.AbstractNamespace          xml.XMLNamespace
  xml.set_namespace              xml.register_namespace


Global API
==========

The prototype for the functions "get_abspath", "get_version" and "setup"
has changed.  The required globals namespace has been dropped:

  Before                          Now
  -----------------------------   -------------
  get_abspath(globals(), '...')   get_abspath('...')
  get_version(globals())          get_version()
  setup(globals())                setup()


itools.csv
=============

The 'Table.get_field_title' method has been moved to ikaaro.


itools.gettext
==============

(1) The way to translate a message from a Python file has considerably
changed:

  # Before
  message = u'...'
  self.gettext(message)

  # Now
  from itools.gettext import MSG
  message = MSG(u'...')
  message.gettext()

And the "DomainAware" class has dissapeared:

  # Before
  from itools.gettext import DomainAware
  class MyClass(DomainAware):
      class_domain = 'my_project'
      ...

  # Now
  class MyClass(object):
      ...

(2) There are some changes to the 'POFile' API too:

  Before               Now
  -------------------  ----------------
  POFile.get_messages  POFile.get_units
  POFile.set_message   POFile.add_unit
  POUnit.msgid         POUnit.source
  POUnit.msgstr        POUnit.target


itools.handlers
===============

It has been changed how to avoid caching a handler:

  # Before
  file = folder.get_handler('...', cache=False)

  # Now
  database = folder.database
  database.set_use_cache(False)
  file = folder.get_handler('...')
  database.set_use_cache(True)

Some other API changes:

  Before               Now
  -------------------  --------------------
  Handler.mimetype     Handler.get_mimetype
  Python.get_messages  Python.get_units


itools.i18n
===========

The segmentation code has been moved to the itools.srx package.  The
implementation is completely different, now it is based on the SRX
file format.


itools.ical
===========

API changes:

  # Before
  icalendarTable._load_state_from_ical_file

  # Now
  icalendarTable.load_state_from_ical_file


itools.handlers
===============

  Before                Now
  --------------------  --------------------
  ODFFile.get_messages  ODFFile.get_units


itools.stl
==========

Now the STL attributes must always be prefixed:

  # Before
  <stl:block repeat="...">

  # Now
  <stl:block stl:repeat="...">


itools.web
==========

(1) The architecture of the web framework has considerably changed.  Before
a URL was mapped to a method, now it is mapped to a instance of the 'BaseView'
class:

  # Before
  from itools.web import Node
  class MyClass(Node):
      view__access__ = True
      def view(self, context):
          ...

  # Now
  from itools.web import Resource, BaseView
  class MyClassView(BaseView):
      access = True
      def GET(self, resource, context):
          ...

  class MyClass(Resource):
      view = MyClassView()

(2) When a view is not explicitly defined, now the server will use the
'default view'.  Example:

  # Before
  class MyClass(Node):
      def GET(self, context):
          return context.uri.resolve2(';view')

  # Now
  class MyClass(Resource):
      default_view_name = 'view'

This example also illustrates that now we do not recommend to redirect to a
default view, but to return straight away the response to the client:

  # Before
  GET / HTTP/1.1
  HTTP/1.1 302 Found

  GET /;view HTTP/1.1
  HTTP/1.1 200 OK

  # Now
  GET / HTTP/1.1
  HTTP/1.1 200 OK

(3) The naming has changed.  What before was sometimes called 'node' and
sometimes 'object', is now named 'resource'.  Some attributes of the
context object have changed their name too.  The table below summarizes
these changes.

  Before (alphabetical order)    Now
  ----------------------------   ---------------------------
  Context.method                 Context.view_name
  Context.object                 Context.resource
  Node._get_object               Resource._get_resource
  Node._has_object               Resource._has_resource
  Node.copy_object               Resource.copy_resource
  Node.del_object                Resource.del_resource
  Node.get_object                Resource.get_resource
  Node.get_objects               Resource.get_resources
  Node.get_real_object           Resource.get_real_resource
  Node.has_object                Resource.has_resource
  Node.move_object               Resource.move_resource
  Node.set_object                Resource.set_resource
  Node.traverse_objects          Resource.traverse_resources

(4) The prototype of the 'Context.get_form_value' method has changed, the
order of its optional parameters have been swapped:

  # Before
  Context.get_form_value(name, default=None, type=String)

  # Now
  Context.get_form_value(name, type=String, default=None)

Other context methods have been removed, the functionality they provided is
now available through the views interface.  These methods are:

  # Removed
  Context.build_form_namespace(schema, method=None)
  Context.check_form_input(schema)

The 'context.commit' attribute has been dropped.

(5) The access control API has changed too, now the 'is_access_allowed' method
expects a 'View' instead of a method name.

  # Before
  AccessControl.is_access_allowed(user, resource, method_name)

  # Now
  AccessControl.is_access_allowed(user, resource, view)

(6) The only CSS classes defined byt itools.web have been renamed:

  Before           Now
  --------------   -----------------
  field_required   field_is_required
  missing          field_is_missing


itools.xml
==========

(1) Now the parser returns a different value for DOCUMENT_TYPE events.

  # Before
  if event == DOCUMENT_TYPE:
      name, system_id, public_id, has_internal_subset = value
      if public_id is None:
          print '<!DOCTYPE %s SYSTEM "%s">' % (name, system_id)
      elif ...

  # Now
  if event == DOCUMENT_TYPE:
      name, doctype = value
      print '<!DOCTYPE %s %s>' % (name, doctype.to_str())

(2) The way to define a new XML namespace has changed.  Most notably now
it is possible to precisely define the attributes of each element.

  # Before
  from itools.xml import AbstractNamespace, set_namespace
  class MyNamespace(AbstractNamespace):
      class_uri = myuri
      class_prefix = myprefix
      elements_schema = {
        'a': ...,
	...
      }
      datatypes = {
        'hfef': ...,
	...
      }
  set_namespace(MyNamespace)

  # Now
  from itools.xml import XMLNamespace, ElementSchema, register_namespace
  myelements = [
      ElementSchema('a', ['href']),
      ...
  ]
  my_namespace = XMLNamespace(myuri, myprefix, myelements)
  register_namespace(my_namespace)


(3) The public namespaces API has changed too.  These are some of the changes:

  # Before
  from itools.xml import get_element_schema
  get_element_schema(tag_uri, tag_name).get_attr_datatype(att_uri, att_name)

  # Now
  from itools.xml import get_attr_datatype
  get_attr_datatype(tag_uri, tag_name, att_uri, att_name)

The 'get_attr_datatype' function accepts the optional parameter 'attributes',
since the datatype of an attribute may depend on other attributes.  The
example below illustrates this, and also how the 'is_translatable' method
has been replaced:

  # Before
  from itools.xml import get_namespace
  ns = get_namespace(tag_uri)
  if ns.is_translatable(tag_uri, tag_name, attributes, attr_name):
      ...

  # Now
  dt = get_attr_datatype(tag_uri, tag_name, att_uri, att_name, attributes)
  if isinstance(dt, Unicode):
      ...

  Before                          Now
  ------------------------------  -------------------------------
  AbstractNamespace.get_element   XMLNamespace.get_element_schema
  AbstractNamespace.get_datatype  XMLNamespace.get_attr_datatype


(4) There are other API changes.

  # Before
  element = html_doc.get_body()
  print element.get_body_as_html()

  # Now
  print html_doc.get_body_as_html()

